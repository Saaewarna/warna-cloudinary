<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warna Cloudinary</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4CAF50; --primary-dark: #388E3C;
            --bg: #f4f7f6; --card: #ffffff;
            --text: #333; --muted: #666; --border: #eee;
            --folder-color: #FFC107;
        }
        body.dark-mode {
            --bg: #1a1a1a; --card: #2d2d2d;
            --text: #e0e0e0; --muted: #aaa; --border: #444;
        }
        body { font-family: 'Calibri', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; transition: 0.3s; }
        .container { max-width: 900px; width: 100%; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        
        /* UI Components */
        .btn { padding: 10px 18px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); cursor: pointer; border-radius: 6px; padding: 8px 15px; font-weight: bold; }
        
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); box-sizing: border-box;}
        
        .auth-card { max-width: 400px; margin: 40px auto; text-align: center; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border); }
        .drop-zone { border: 2px dashed #ccc; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; margin-bottom: 20px; }
        .drop-zone:hover { border-color: var(--primary); opacity: 0.8; }

        /* OPTION TOGGLE */
        .upload-options { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* BREADCRUMB & TOOLBAR */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .breadcrumb { font-size: 1.1em; font-weight: bold; display: flex; align-items: center; gap: 8px; flex-grow: 1; }
        .breadcrumb span { cursor: pointer; }
        .breadcrumb span:hover { color: var(--primary); text-decoration: underline; }
        .active-folder { color: var(--muted); cursor: default !important; text-decoration: none !important; }
        
        .toolbar-actions { display:flex; gap:10px; align-items: center; }
        #searchInput { margin: 0; padding: 8px 12px; width: 200px; font-size: 0.9em; }

        /* GRID SYSTEM */
        .asset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        
        /* FOLDER CARD */
        .folder-card { 
            background: var(--card); border: 1px solid var(--border); border-radius: 8px; 
            padding: 15px; text-align: center; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 140px; position: relative;
        }
        .folder-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--primary); }
        .folder-icon { font-size: 3.5em; color: var(--folder-color); margin-bottom: 10px; }
        .folder-name { font-weight: bold; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; }
        .folder-delete { position: absolute; top: 5px; right: 5px; color: #f44336; opacity: 0; transition: 0.2s; padding: 5px; }
        .folder-card:hover .folder-delete { opacity: 1; }

        /* ASSET CARD */
        .asset-card { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--card); position: relative; height: 170px;}
        .asset-card img, .asset-card video { width: 100%; height: 120px; object-fit: cover; display: block; }
        .asset-info { padding: 8px; font-size: 0.85em; color: var(--muted); border-top: 1px solid var(--border); }
        .action-overlay { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; transition: 0.2s; }
        .asset-card:hover .action-overlay { opacity: 1; }
        .icon-btn { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* THEME TOGGLE */
        .theme-toggle { position: absolute; top: 20px; left: 20px; cursor: pointer; font-size: 1.5rem; }
    </style>
</head>
<body>

    <div class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon" id="themeIcon"></i></div>

    <div id="authSection" class="container auth-card">
        <h1 style="color:var(--primary);">Warna Cloudinary</h1>
        <h3 style="color:var(--muted); margin-bottom:20px;">Jika belum ada akun, konfirmasi admin.</h3>
        <form id="loginForm">
            <input type="text" id="loginUser" placeholder="Username" required />
            <input type="password" id="loginPass" placeholder="Password" required />
            <button type="submit" class="btn" style="width:100%;">Masuk</button>
        </form>
    </div>

    <div id="dashboardSection" class="container hidden">
        <div class="dash-header">
            <h2><i class="fas fa-cloud"></i> Dashboard</h2>
            <button onclick="logout()" class="btn-outline">Logout</button>
        </div>

        <div class="drop-zone" id="dropZone">
            <i class="fas fa-cloud-upload-alt"></i>
            <div style="margin-top:10px;">Drag & Drop, Klik, atau <strong>CTRL+V</strong> di sini</div>
            <input type="file" id="fileInput" name="images" accept="image/*,video/*" multiple style="display:none;" />
        </div>

        <div class="upload-options">
            <span>Original Quality</span>
            <label class="switch">
                <input type="checkbox" id="compressToggle" checked>
                <span class="slider"></span>
            </label>
            <span style="color:var(--primary);">Compress & Optimize</span>
        </div>

        <div id="bulkStatus" style="text-align:center; margin-bottom:20px; color:var(--primary); font-weight:bold;"></div>

        <div class="toolbar">
            <div class="breadcrumb" id="breadcrumb"></div>
            <div class="toolbar-actions">
                <input type="text" id="searchInput" placeholder="Cari..." />
                <button onclick="createFolder()" class="btn-outline" title="Buat Folder"><i class="fas fa-folder-plus"></i></button>
                <button onclick="refreshData()" class="btn-outline" title="Refresh"><i class="fas fa-sync"></i></button>
            </div>
        </div>

        <div id="contentGrid" class="asset-grid"></div>
    </div>

    <script>
        let API_KEY = localStorage.getItem('mini_key');
        let CURRENT_FOLDER = null; 
        let CURRENT_FOLDER_NAME = 'Home';

        // --- THEME ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        if(localStorage.getItem('theme') === 'dark') toggleTheme();

        // --- AUTH ---
        function checkLogin() {
            if (API_KEY) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                refreshData();
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if(res.ok) {
                    localStorage.setItem('mini_key', data.apiKey);
                    API_KEY = data.apiKey;
                    checkLogin();
                } else alert(data.error);
            } catch(e) { alert('Error connect'); }
        });

        window.logout = () => { localStorage.clear(); location.reload(); }

        // --- SEARCH ---
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.folder-card').forEach(card => {
                const name = card.querySelector('.folder-name').innerText.toLowerCase();
                card.style.display = name.includes(term) ? 'flex' : 'none';
            });
            document.querySelectorAll('.asset-card').forEach(card => {
                const name = card.querySelector('.asset-info div').innerText.toLowerCase();
                card.style.display = name.includes(term) ? 'block' : 'none';
            });
        });

        // --- DATA LOADING ---
        async function refreshData() {
            const grid = document.getElementById('contentGrid');
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            grid.innerHTML = '<p>Loading...</p>';
            let url = '/api/assets';
            if(CURRENT_FOLDER) url += `?folderId=${CURRENT_FOLDER}`;

            try {
                const res = await fetch(url, { headers: { 'x-api-key': API_KEY } });
                const data = await res.json();
                renderBreadcrumb(data.currentFolder);
                grid.innerHTML = '';

                if(data.folders) {
                    data.folders.forEach(f => {
                        grid.innerHTML += `
                            <div class="folder-card" onclick="openFolder(${f.id}, '${f.name}')">
                                <div class="folder-delete" onclick="deleteFolder(${f.id}, event)" title="Hapus Folder"><i class="fas fa-times"></i></div>
                                <i class="fas fa-folder folder-icon"></i>
                                <div class="folder-name">${f.name}</div>
                            </div>
                        `;
                    });
                }

                if(data.assets) {
                    data.assets.forEach(a => {
                        const isVid = a.mimeType.startsWith('video');
                        const media = isVid ? `<video src="${a.url}"></video>` : `<img src="${a.url}" loading="lazy">`;
                        grid.innerHTML += `
                            <div class="asset-card">
                                <div class="action-overlay">
                                    <div class="icon-btn" onclick="renameAsset(${a.id}, '${a.fileName}')" style="color:blue"><i class="fas fa-pen"></i></div>
                                    <div class="icon-btn" onclick="deleteAsset(${a.id})" style="color:red"><i class="fas fa-trash"></i></div>
                                    <div class="icon-btn" onclick="copyUrl('${a.url}')" style="color:green"><i class="fas fa-link"></i></div>
                                </div>
                                ${media}
                                <div class="asset-info">
                                    <div style="font-weight:bold; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${a.fileName}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                if(grid.innerHTML === '') grid.innerHTML = '<p style="color:#888; grid-column:1/-1; text-align:center;">Folder kosong.</p>';
            } catch(e) { console.error(e); }
        }

        function renderBreadcrumb(folderObj) {
            const bc = document.getElementById('breadcrumb');
            if(!folderObj) {
                CURRENT_FOLDER = null;
                bc.innerHTML = `<span class="active-folder"><i class="fas fa-home"></i> Home</span>`;
            } else {
                CURRENT_FOLDER = folderObj.id;
                bc.innerHTML = `
                    <span onclick="openFolder(null)"><i class="fas fa-home"></i> Home</span> 
                    <i class="fas fa-chevron-right" style="font-size:0.8em; color:#ccc;"></i> 
                    <span class="active-folder">${folderObj.name}</span>
                `;
            }
        }

        window.openFolder = (id) => { CURRENT_FOLDER = id; refreshData(); }

        window.createFolder = async () => {
            const name = prompt("Nama Folder Baru:");
            if(!name) return;
            try {
                await fetch('/api/folders', {
                    method: 'POST',
                    headers: { 'x-api-key': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, parentId: CURRENT_FOLDER })
                });
                refreshData();
            } catch(e) { alert('Gagal buat folder'); }
        }

        window.deleteFolder = async (id, e) => {
            e.stopPropagation();
            if(!confirm("Hapus folder? Isi file akan dipindah ke Home.")) return;
            try {
                await fetch(`/api/folders/${id}`, { method: 'DELETE', headers: { 'x-api-key': API_KEY } });
                refreshData();
            } catch(e) { alert('Gagal hapus'); }
        }

        // --- UPLOAD LOGIC & PASTE SUPPORT ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = 'green'; };
        dropZone.ondragleave = () => dropZone.style.borderColor = '#ccc';
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.style.borderColor = '#ccc'; handleUpload(e.dataTransfer.files); };
        fileInput.onchange = (e) => handleUpload(e.target.files);

        window.addEventListener('paste', (e) => {
            if (!API_KEY || document.getElementById('dashboardSection').classList.contains('hidden')) return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            const files = [];
            for (let item of items) {
                if (item.kind === 'file') {
                    const file = item.getAsFile();
                    if (file) files.push(file);
                }
            }
            if (files.length > 0) handleUpload(files);
        });

        async function handleUpload(files) {
            if(!files.length) return;

            const validFiles = [];
            let rejectedCount = 0;
            for(let i=0; i<files.length; i++) {
                const file = files[i];
                if(file.type.startsWith('image/') || file.type.startsWith('video/')) {
                    validFiles.push(file);
                } else { rejectedCount++; }
            }

            if(rejectedCount > 0) alert(`⚠️ Ada ${rejectedCount} file ditolak karena bukan Gambar/Video!`);
            if(validFiles.length === 0) return;

            const status = document.getElementById('bulkStatus');
            status.innerText = `Uploading ${validFiles.length} files...`;
            
            // CHECKBOX STATE
            const shouldOptimize = document.getElementById('compressToggle').checked;

            const formData = new FormData();
            if(CURRENT_FOLDER) formData.append('folderId', CURRENT_FOLDER);
            formData.append('optimize', shouldOptimize); // KIRIM PILIHAN USER

            for(let f of validFiles) formData.append('images', f);

            try {
                const res = await fetch('/upload-bulk', {
                    method: 'POST',
                    headers: { 'x-api-key': API_KEY },
                    body: formData
                });
                const data = await res.json();
                status.innerText = "";
                if(res.ok) refreshData();
                else alert('Server Error: ' + (data.error || 'Gagal upload'));
            } catch(e) { alert('Upload failed: Koneksi error'); status.innerText = ""; }
        }

        window.deleteAsset = async (id) => {
            if(!confirm("Hapus file?")) return;
            await fetch(`/api/assets/${id}`, { method: 'DELETE', headers: { 'x-api-key': API_KEY } });
            refreshData();
        }
        window.renameAsset = async (id, oldName) => {
            const newName = prompt("Rename:", oldName);
            if(newName && newName !== oldName) {
                await fetch(`/api/assets/${id}`, {
                    method: 'PUT',
                    headers: { 'x-api-key': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newName })
                });
                refreshData();
            }
        }

        window.copyUrl = (url) => {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => alert('URL Tersalin!')).catch(() => fallbackCopy(url));
            } else { fallbackCopy(url); }
        }

        function fallbackCopy(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try { document.execCommand('copy'); alert('URL Tersalin!'); } catch (err) { alert('Gagal copy.'); }
            document.body.removeChild(textArea);
        }

        checkLogin();
    </script>
</body>
</html>
